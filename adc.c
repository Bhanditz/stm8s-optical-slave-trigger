/*==============================================================================
 * MODULE: ADC
 * DESCRIPTION: Implementation of the ADC module
 *============================================================================*/
/*==============================================================================
 * INCLUDES
 *============================================================================*/
#include "main.h"
#include "adc.h"
/*==============================================================================
 * CONSTANTS
 *============================================================================*/
/*==============================================================================
 * MACROS
 *============================================================================*/
/*==============================================================================
 * TYPEDEFs and STRUCTs
 *============================================================================*/
/*==============================================================================
 * LOCAL FUNCTION PROTOTYPES
 *============================================================================*/
/*==============================================================================
 * LOCAL VARIABLES
 *============================================================================*/
/*==============================================================================
 * GLOBAL (extern) VARIABLES
 *============================================================================*/
/*==============================================================================
 * LOCAL FUNCTIONS
 *============================================================================*/
/*==============================================================================
 * EXPORTED (GLOBAL) FUNCTIONS
 *============================================================================*/
/*==============================================================================
 * DESCRIPTION:
 * @param
 * @return
 * @precondition
 * @postcondition
 * @caution
 * @notes
 *============================================================================*/
void OT_ADC_init(void) {
  // First configure the GPIO for analog
  GPIO_Init(DELAY_SENSE_PORT, DELAY_SENSE_PIN, DELAY_SENSE_MODE);
  // Set-up the ADC
  ADC1_DeInit();
  ADC1_Init(ADC1_CONVERSIONMODE_SINGLE, DELAY_SENSE_ADC_CHANNEL,
            ADC1_PRESSEL_FCPU_D18, ADC1_EXTTRIG_TIM, DISABLE, ADC1_ALIGN_RIGHT,
            DELAY_SENSE_SCHMTRIG_CHANNEL, DISABLE);
  ADC1_Cmd(DISABLE);
  return;
}
/*==============================================================================
 * DESCRIPTION:
 * @param
 * @return
 * @precondition
 * @postcondition
 * @caution
 * @notes
 *============================================================================*/
uint8_t OT_ADC_read_delay_sense(void) {
  uint16_t retval = 0;
  ADC1_Cmd(ENABLE);
  ADC1_StartConversion();
  while (RESET == ADC1_GetFlagStatus(ADC1_FLAG_EOC));
  retval = ADC1_GetConversionValue();
  ADC1_Cmd(DISABLE);
  // The ADC1 sampling resolution is 10-bit and we want to return 8-bit values
  return (retval >> 2);
}
/*============================================================================*/
